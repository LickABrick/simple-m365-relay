services:
  postfix:
    build:
      context: .
      dockerfile: postfix/Dockerfile
    container_name: simple-m365-relay-postfix
    restart: unless-stopped
    ports:
      - "25:25"
      - "587:587"
    environment:
      RELAY_HOSTNAME: ${RELAY_HOSTNAME:-relay.local}
      RELAY_DOMAIN: ${RELAY_DOMAIN:-local}
      RELAY_MYNETWORKS: ${RELAY_MYNETWORKS:-127.0.0.0/8}

      RELAY_SMTPD_TLS_LEVEL_25: ${RELAY_SMTPD_TLS_LEVEL_25:-may}
      RELAY_SMTPD_TLS_LEVEL_587: ${RELAY_SMTPD_TLS_LEVEL_587:-encrypt}

      RELAY_TLS_GENERATE_SELF_SIGNED: ${RELAY_TLS_GENERATE_SELF_SIGNED:-true}
      RELAY_TLS_CERT_PATH: ${RELAY_TLS_CERT_PATH:-/data/certs/tls.crt}
      RELAY_TLS_KEY_PATH: ${RELAY_TLS_KEY_PATH:-/data/certs/tls.key}
      RELAY_TLS_SELF_SIGNED_CN: ${RELAY_TLS_SELF_SIGNED_CN:-relay.local}

      RELAYHOST: ${RELAYHOST:-[smtp.office365.com]:587}
      MS365_SMTP_USER: ${MS365_SMTP_USER:-postfix@example.com}

      MS365_TENANT_ID: ${MS365_TENANT_ID:-}
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}

      CONTROL_BIND: ${CONTROL_BIND:-0.0.0.0}
      CONTROL_PORT: ${CONTROL_PORT:-18080}
      # Prefer unix domain socket for the control API. If set, postfix listens on this socket path.
      CONTROL_SOCKET: ${CONTROL_SOCKET:-/data/state/control.sock}
      # Shared token required for all control API calls (UI â†’ postfix)
      # If unset, postfix generates /data/state/control.token and UI reads it from the shared volume.
      CONTROL_TOKEN: ${CONTROL_TOKEN:-}

      # Background token refresh (uses existing refresh token)
      AUTO_TOKEN_REFRESH_MINUTES: ${AUTO_TOKEN_REFRESH_MINUTES:-30}
    volumes:
      - simple-m365-relay-data:/data
    expose:
      - "18080"

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    container_name: simple-m365-relay-ui
    restart: unless-stopped
    ports:
      - "8000:8000"  # put behind reverse proxy + basic auth
    environment:
      UI_BIND: ${UI_BIND:-0.0.0.0}
      UI_PORT: ${UI_PORT:-8000}
      UI_BASE_URL: ${UI_BASE_URL:-}
      # If behind a TLS-terminating reverse proxy, you likely want:
      #   FORCE_SECURE_COOKIES=1 and TRUST_PROXY_HEADERS=1
      FORCE_SECURE_COOKIES: ${FORCE_SECURE_COOKIES:-}
      TRUST_PROXY_HEADERS: ${TRUST_PROXY_HEADERS:-}
      POSTFIX_CONTROL_URL: ${POSTFIX_CONTROL_URL:-http://postfix:18080}
      # If set, UI uses unix socket instead of TCP for control API.
      POSTFIX_CONTROL_SOCKET: ${POSTFIX_CONTROL_SOCKET:-/data/state/control.sock}
      CONTROL_TOKEN: ${CONTROL_TOKEN:-}
      RELAY_DOMAIN: ${RELAY_DOMAIN:-local}
      DATA_DIR: ${DATA_DIR:-/data}

      # Display + token expiry parsing (same as postfix)
      RELAYHOST: ${RELAYHOST:-[smtp.office365.com]:587}
      MS365_SMTP_USER: ${MS365_SMTP_USER:-postfix@example.com}
      MS365_TENANT_ID: ${MS365_TENANT_ID:-}
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}
      AUTO_TOKEN_REFRESH_MINUTES: ${AUTO_TOKEN_REFRESH_MINUTES:-30}
    volumes:
      - simple-m365-relay-data:/data
    depends_on:
      - postfix

volumes:
  # Keep the underlying Docker volume name to preserve existing data
  simple-m365-relay-data:
    name: ms365-relay_ms365-relay-data
