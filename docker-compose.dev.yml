# Standalone development compose.
# Uses separate volume + non-conflicting ports.

services:
  postfix:
    build:
      context: .
      dockerfile: postfix/Dockerfile
    container_name: simple-m365-relay-postfix-dev
    restart: unless-stopped
    # Avoid port conflicts with the main stack; publish dev ports instead.
    ports:
      - "2525:25"
      - "1587:587"
    environment:
      RELAY_HOSTNAME: ${RELAY_HOSTNAME:-relay.dev.local}
      RELAY_DOMAIN: ${RELAY_DOMAIN:-dev.local}
      RELAY_MYNETWORKS: ${RELAY_MYNETWORKS:-127.0.0.0/8}

      RELAY_SMTPD_TLS_LEVEL_25: ${RELAY_SMTPD_TLS_LEVEL_25:-may}
      RELAY_SMTPD_TLS_LEVEL_587: ${RELAY_SMTPD_TLS_LEVEL_587:-encrypt}

      RELAY_TLS_GENERATE_SELF_SIGNED: ${RELAY_TLS_GENERATE_SELF_SIGNED:-true}
      RELAY_TLS_CERT_PATH: ${RELAY_TLS_CERT_PATH:-/data/certs/tls.crt}
      RELAY_TLS_KEY_PATH: ${RELAY_TLS_KEY_PATH:-/data/certs/tls.key}
      RELAY_TLS_SELF_SIGNED_CN: ${RELAY_TLS_SELF_SIGNED_CN:-relay.dev.local}

      RELAYHOST: ${RELAYHOST:-[smtp.office365.com]:587}
      MS365_SMTP_USER: ${MS365_SMTP_USER:-postfix@example.com}

      MS365_TENANT_ID: ${MS365_TENANT_ID:-}
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}

      CONTROL_SOCKET: ${CONTROL_SOCKET:-/data/state/control.sock}
      CONTROL_TOKEN: ${CONTROL_TOKEN:-}

      AUTO_TOKEN_REFRESH_MINUTES: ${AUTO_TOKEN_REFRESH_MINUTES:-30}
      OAUTH_LOG_FULL_TRACE: ${OAUTH_LOG_FULL_TRACE:-no}
      OAUTH_LOG_TO_SYSLOG: ${OAUTH_LOG_TO_SYSLOG:-yes}
    volumes:
      - simple-m365-relay-dev-data:/data
    expose:
      - "18080"

  ui:
    build:
      context: .
      dockerfile: ui/Dockerfile
    container_name: simple-m365-relay-ui-dev
    restart: unless-stopped
    ports:
      - "8001:8000"
    security_opt:
      - no-new-privileges:true
    cap_drop:
      - ALL
    read_only: true
    tmpfs:
      - /tmp
    environment:
      UI_BIND: ${UI_BIND:-0.0.0.0}
      UI_PORT: ${UI_PORT:-8000}
      UI_BASE_URL: ${UI_BASE_URL:-}
      FORCE_SECURE_COOKIES: ${FORCE_SECURE_COOKIES:-}
      TRUST_PROXY_HEADERS: ${TRUST_PROXY_HEADERS:-}
      POSTFIX_CONTROL_URL: ${POSTFIX_CONTROL_URL:-http://postfix:18080}
      POSTFIX_CONTROL_SOCKET: ${POSTFIX_CONTROL_SOCKET:-/data/state/control.sock}
      CONTROL_TOKEN: ${CONTROL_TOKEN:-}
      RELAY_DOMAIN: ${RELAY_DOMAIN:-dev.local}
      DATA_DIR: ${DATA_DIR:-/data}

      RELAYHOST: ${RELAYHOST:-[smtp.office365.com]:587}
      MS365_SMTP_USER: ${MS365_SMTP_USER:-postfix@example.com}
      MS365_TENANT_ID: ${MS365_TENANT_ID:-}
      MS365_CLIENT_ID: ${MS365_CLIENT_ID:-}
      AUTO_TOKEN_REFRESH_MINUTES: ${AUTO_TOKEN_REFRESH_MINUTES:-30}
    volumes:
      - simple-m365-relay-dev-data:/data
    depends_on:
      - postfix

volumes:
  simple-m365-relay-dev-data:
    name: ms365-relay_dev-data
