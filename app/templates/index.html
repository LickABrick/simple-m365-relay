<!doctype html>
<html lang="en" class="h-full scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ms365-relay</title>

  <!-- Tailwind (CDN) -->
  <script>
    // IMPORTANT: Tailwind CDN defaults to darkMode: 'media'. Force class-based.
    // Must be defined BEFORE loading the CDN script.
    window.tailwind = { config: { darkMode: 'class' } };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    // Theme (persisted)
    const themeKey = 'ms365-relay-theme';
    const saved = localStorage.getItem(themeKey);
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if ((saved === 'dark') || (!saved && prefersDark)) {
      document.documentElement.classList.add('dark');
    }

    function setTheme(mode){
      const isDark = (mode === 'dark');
      document.documentElement.classList.toggle('dark', isDark);
      // also toggle on body in case of any CSS that targets body.dark
      if (document.body) document.body.classList.toggle('dark', isDark);
      localStorage.setItem(themeKey, mode);
      syncThemeButton();
    }

    function toggleTheme(){
      const isDark = document.documentElement.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    }

    function syncThemeButton(){
      const btn = document.getElementById('themeBtn');
      const label = document.getElementById('themeBtnLabel');
      if (!btn || !label) return;
      const isDark = document.documentElement.classList.contains('dark');
      label.textContent = isDark ? 'Light' : 'Dark';
      btn.setAttribute('title', isDark ? 'Switch to light mode' : 'Switch to dark mode');
    }

    function setActiveNavById(id){
      const hash = '#' + id;
      for (const a of document.querySelectorAll('a[data-nav]')) {
        const active = a.getAttribute('href') === hash;
        a.classList.toggle('bg-slate-100', active);
        a.classList.toggle('text-slate-900', active);
        a.classList.toggle('dark:bg-slate-800', active);
        a.classList.toggle('dark:text-white', active);
      }
    }

    function initScrollSpy(){
      const ids = ['status','settings','users','senders','oauth','logs'];
      const els = ids.map(id => document.getElementById(id)).filter(Boolean);
      if (!els.length) return;

      const obs = new IntersectionObserver((entries) => {
        // pick the entry closest to the top that is intersecting
        const intersecting = entries.filter(e => e.isIntersecting);
        if (!intersecting.length) return;
        intersecting.sort((a,b) => Math.abs(a.boundingClientRect.top) - Math.abs(b.boundingClientRect.top));
        const id = intersecting[0].target && intersecting[0].target.id;
        if (id) setActiveNavById(id);
      }, {
        root: null,
        // activate when the section passes under the sticky header
        rootMargin: '-96px 0px -70% 0px',
        threshold: [0.01, 0.1, 0.25]
      });

      for (const el of els) obs.observe(el);

      // initial
      const initial = (location.hash || '#status').slice(1);
      setActiveNavById(initial || 'status');
    }

    // smooth scrolling for sidebar clicks (and update hash)
    function initNavClicks(){
      for (const a of document.querySelectorAll('a[data-nav]')) {
        a.addEventListener('click', (e) => {
          const href = a.getAttribute('href') || '';
          if (!href.startsWith('#')) return;
          const id = href.slice(1);
          const target = document.getElementById(id);
          if (!target) return;
          e.preventDefault();
          history.replaceState(null, '', href);
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          setActiveNavById(id);
        });
      }
    }

    window.addEventListener('DOMContentLoaded', () => {
      try { lucide.createIcons(); } catch(e) {}
      syncThemeButton();
      initNavClicks();
      initScrollSpy();
    });
  </script>

  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <div class="min-h-full">

    <!-- Top bar -->
    <header class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur dark:border-slate-800 dark:bg-slate-950/70">
      <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3 sm:px-6 lg:px-8">
        <div class="flex items-center gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-blue-600 text-white">
            <i data-lucide="mail" class="h-5 w-5"></i>
          </div>
          <div>
            <div class="text-sm font-semibold leading-5">ms365-relay</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">Postfix â†’ Microsoft 365 (XOAUTH2)</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <button id="themeBtn" type="button" onclick="toggleTheme()"
            class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800">
            <i data-lucide="moon" class="h-4 w-4"></i>
            <span id="themeBtnLabel">Dark</span>
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto grid max-w-7xl grid-cols-1 gap-6 px-4 py-6 sm:px-6 lg:grid-cols-12 lg:px-8">

      <!-- Sidebar -->
      <aside class="lg:col-span-3">
        <div class="sticky top-[4.75rem] self-start">
        <nav class="space-y-1">
          <a data-nav href="#status" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="activity" class="h-4 w-4"></i> Status
          </a>
          <a data-nav href="#settings" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="settings" class="h-4 w-4"></i> Settings
          </a>
          <a data-nav href="#users" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="users" class="h-4 w-4"></i> Users
          </a>
          <a data-nav href="#senders" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="at-sign" class="h-4 w-4"></i> Allowed From
          </a>
          <a data-nav href="#oauth" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="key-round" class="h-4 w-4"></i> OAuth
          </a>
          <a data-nav href="#logs" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="scroll-text" class="h-4 w-4"></i> Logs
          </a>
        </nav>

        <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-4 text-xs text-slate-600 shadow-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-300">
          <div class="font-semibold text-slate-700 dark:text-slate-200">Security note</div>
          <div class="mt-1">This UI has no auth by design. Keep it behind a reverse proxy with basic auth.</div>
        </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="space-y-6 lg:col-span-9">

        <!-- STATUS -->
        <div id="status" class="scroll-mt-24">
          <div class="flex items-center justify-between">
            <h2 class="text-lg font-semibold">Status</h2>
            <div class="flex gap-2">
              <form method="post" action="/postfix/render_reload">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                  <i data-lucide="sparkles" class="h-4 w-4"></i>
                  Render + reload
                </button>
              </form>
              <form method="post" action="/postfix/reload">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800">
                  <i data-lucide="rotate-cw" class="h-4 w-4"></i>
                  Reload
                </button>
              </form>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Queue</div>
              <div class="mt-1 text-2xl font-semibold">{{ queue_size }}</div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Relayhost</div>
              <div class="mt-1 truncate text-sm font-semibold" title="{{ env.RELAYHOST }}">{{ env.RELAYHOST }}</div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">M365 user</div>
              <div class="mt-1 truncate text-sm font-semibold" title="{{ env.MS365_SMTP_USER }}">{{ env.MS365_SMTP_USER }}</div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Token expiry</div>
              <div class="mt-1 text-sm font-semibold">{{ token_exp or "(unknown)" }}</div>
            </div>
          </div>
        </div>

        <!-- SETTINGS -->
        <div id="settings" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="settings" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">Settings</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Hostname + trusted subnets (mynetworks).</p>

          <form method="post" action="/settings" class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
              <label class="text-sm font-medium">Hostname</label>
              <input name="hostname" value="{{ cfg.hostname }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div>
              <label class="text-sm font-medium">Domain</label>
              <input name="domain" value="{{ cfg.domain }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm font-medium">Trusted subnets (mynetworks; space/comma separated)</label>
              <input name="mynetworks" value="{{ (cfg.mynetworks or []) | join(' ') }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div class="sm:col-span-2 flex justify-end">
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-slate-900 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-slate-800 dark:bg-white dark:text-slate-900 dark:hover:bg-slate-200">
                <i data-lucide="save" class="h-4 w-4"></i>
                Save
              </button>
            </div>
          </form>

          <div class="mt-4 rounded-xl bg-slate-50 p-3 text-xs text-slate-600 dark:bg-slate-950 dark:text-slate-300">
            Ports/TLS and M365 OAuth settings are controlled by environment variables (compose).
          </div>
        </div>

        <!-- USERS -->
        <div id="users" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="users" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">SMTP AUTH users</h2>
          </div>

          <div class="mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-800 dark:bg-slate-950">
            <pre class="mono max-h-56 overflow-auto text-xs">{{ users }}</pre>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <form method="post" action="/users/add" class="space-y-2">
              <div class="text-sm font-medium">Add / update</div>
              <input name="login" placeholder="username" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <input name="password" placeholder="password" type="password" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-500">
                <i data-lucide="user-plus" class="h-4 w-4"></i>
                Save
              </button>
            </form>

            <form method="post" action="/users/delete" class="space-y-2">
              <div class="text-sm font-medium">Delete</div>
              <input name="login" placeholder="username" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-red-200 bg-white px-3 py-2 text-sm font-semibold text-red-700 hover:bg-red-50 dark:border-red-900/40 dark:bg-slate-950 dark:text-red-300 dark:hover:bg-red-950/40">
                <i data-lucide="trash-2" class="h-4 w-4"></i>
                Delete
              </button>
            </form>
          </div>
        </div>

        <!-- SENDERS -->
        <div id="senders" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="at-sign" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">Allowed From addresses</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">
            Enforced via <span class="mono">smtpd_sender_login_maps</span> + <span class="mono">reject_sender_login_mismatch</span>.
          </p>

          <div class="mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-800 dark:bg-slate-950">
            <pre class="mono max-h-64 overflow-auto text-xs">{{ (cfg.allowed_from or {}) | tojson(indent=2) }}</pre>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <form method="post" action="/from/allow" class="space-y-2">
              <div class="text-sm font-medium">Allow sender</div>
              <input name="login" placeholder="login" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <input name="from_addr" placeholder="from@example.com" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-500">
                <i data-lucide="plus" class="h-4 w-4"></i>
                Allow
              </button>
            </form>

            <form method="post" action="/from/disallow" class="space-y-2">
              <div class="text-sm font-medium">Disallow sender</div>
              <input name="login" placeholder="login" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <input name="from_addr" placeholder="from@example.com" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800">
                <i data-lucide="minus" class="h-4 w-4"></i>
                Disallow
              </button>
            </form>
          </div>
        </div>

        <!-- OAUTH -->
        <div id="oauth" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="key-round" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">OAuth device flow</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">
            Starts a device flow using <span class="mono">sasl-xoauth2-tool</span> and writes the token into the shared volume.
          </p>

          <form method="post" action="/token/start" class="mt-4">
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-500">
              <i data-lucide="play" class="h-4 w-4"></i>
              Start device flow
            </button>
          </form>

          <div class="mt-4 rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-800 dark:bg-slate-950">
            <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Log (tail)</div>
            <pre class="mono mt-2 max-h-72 overflow-auto text-xs">{{ device_flow_log }}</pre>
          </div>
        </div>

        <!-- LOGS -->
        <div id="logs" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="scroll-text" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">Mail log (tail)</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Recent Postfix activity.</p>
          <div class="mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-800 dark:bg-slate-950">
            <pre class="mono max-h-[36rem] overflow-auto text-xs">{{ mail_log }}</pre>
          </div>
        </div>

      </section>

    </main>
  </div>
</body>
</html>
