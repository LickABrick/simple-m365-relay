<!doctype html>
<html lang="en" class="h-full scroll-smooth">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ms365-relay</title>

  <!-- Tailwind (CDN) -->
  <script>
    // IMPORTANT: Tailwind CDN defaults to darkMode: 'media'. Force class-based.
    // Must be defined BEFORE loading the CDN script.
    window.tailwind = window.tailwind || {};
    window.tailwind.config = window.tailwind.config || {};
    window.tailwind.config.darkMode = 'class';
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Lucide icons -->
  <script src="https://unpkg.com/lucide@latest"></script>

  <script>
    // Theme (persisted)
    const themeKey = 'ms365-relay-theme';
    const saved = localStorage.getItem(themeKey);
    const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    if ((saved === 'dark') || (!saved && prefersDark)) {
      document.documentElement.classList.add('dark');
    }

    function setTheme(mode){
      const isDark = (mode === 'dark');
      document.documentElement.classList.toggle('dark', isDark);
      // also toggle on body in case of any CSS that targets body.dark
      if (document.body) document.body.classList.toggle('dark', isDark);
      localStorage.setItem(themeKey, mode);
      syncThemeButton();
    }

    function toggleTheme(){
      const isDark = document.documentElement.classList.contains('dark');
      setTheme(isDark ? 'light' : 'dark');
    }

    function syncThemeButton(){
      const btn = document.getElementById('themeBtn');
      const label = document.getElementById('themeBtnLabel');
      if (!btn || !label) return;
      const isDark = document.documentElement.classList.contains('dark');
      label.textContent = isDark ? 'Light' : 'Dark';
      btn.setAttribute('title', isDark ? 'Switch to light mode' : 'Switch to dark mode');
    }

    function setActiveNavById(id){
      const hash = '#' + id;
      for (const a of document.querySelectorAll('a[data-nav]')) {
        const active = a.getAttribute('href') === hash;
        a.classList.toggle('is-active', active);
      }
    }

    function initScrollSpy(){
      // Simple scroll-based spy (works everywhere; avoids IntersectionObserver quirks)
      const ids = ['status','settings','users','senders','oauth','testmail','logs'];
      const els = ids.map(id => document.getElementById(id)).filter(Boolean);
      if (!els.length) return;

      const headerOffset = 96; // sticky header height-ish
      let ticking = false;

      function update(){
        ticking = false;
        const y = window.scrollY + headerOffset + 8;
        let current = els[0].id;
        for (const el of els) {
          if (el.offsetTop <= y) current = el.id;
        }
        setActiveNavById(current);
      }

      function onScroll(){
        if (ticking) return;
        ticking = true;
        window.requestAnimationFrame(update);
      }

      window.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', onScroll);

      // initial
      onScroll();
    }

    // smooth scrolling for sidebar clicks (and update hash)
    function initNavClicks(){
      for (const a of document.querySelectorAll('a[data-nav]')) {
        a.addEventListener('click', (e) => {
          const href = a.getAttribute('href') || '';
          if (!href.startsWith('#')) return;
          const id = href.slice(1);
          const target = document.getElementById(id);
          if (!target) return;
          e.preventDefault();
          history.replaceState(null, '', href);
          target.scrollIntoView({ behavior: 'smooth', block: 'start' });
          setActiveNavById(id);
        });
      }
    }

    function showToast(msg, level){
      const box = document.getElementById('toast');
      const text = document.getElementById('toastText');
      if (!box || !text) return;

      text.textContent = msg;
      box.classList.remove('hidden');
      box.classList.toggle('toast-error', (level === 'error'));

      window.setTimeout(() => {
        box.classList.add('hidden');
      }, 8000);
    }

    function showToastFromUrl(){
      const url = new URL(window.location.href);
      const msg = url.searchParams.get('toast');
      if (!msg) return;
      const level = (url.searchParams.get('toastLevel') || 'ok');

      showToast(msg, level);

      // remove params so refresh doesn't keep re-toasting
      url.searchParams.delete('toast');
      url.searchParams.delete('toastLevel');
      window.history.replaceState({}, '', url.pathname + url.search + url.hash);
    }

    function copyText(elId){
      const el = document.getElementById(elId);
      if (!el) return;
      const text = el.innerText || el.textContent || '';
      navigator.clipboard?.writeText(text);
    }

    function syncFromSelect(){
      const sel = document.getElementById('fromSelect');
      const inp = document.getElementById('fromInput');
      if (!sel || !inp) return;
      if (sel.value) inp.value = sel.value;
    }

    function fillToMyself(){
      const inp = document.getElementById('toInput');
      if (!inp) return;
      inp.value = '{{ env.MS365_SMTP_USER }}';
    }

    function _getFullMailLog(){
      const pre = document.getElementById('mailLogPre');
      if (!pre) return '';
      const raw = pre.getAttribute('data-fulljson');
      if (raw) {
        try { return JSON.parse(raw); } catch (e) {}
      }
      return pre.textContent || '';
    }

    function applyLogFilter(){
      const pre = document.getElementById('mailLogPre');
      if (!pre) return;
      const full = _getFullMailLog();
      const q = (document.getElementById('logSearch')?.value || '').toLowerCase();
      const only = !!document.getElementById('logOnlyProblems')?.checked;
      const lines = (full || '').split('\n');
      const out = [];
      for (const ln of lines){
        const ll = ln.toLowerCase();
        if (only && !(ll.includes(' warn ') || ll.includes(' err ') || ll.includes(' fatal') || ll.includes('panic'))) continue;
        if (q && !ll.includes(q)) continue;
        out.push(ln);
      }
      pre.textContent = out.join('\n');
    }

    function clearLogFilter(){
      const s = document.getElementById('logSearch');
      const o = document.getElementById('logOnlyProblems');
      if (s) s.value = '';
      if (o) o.checked = false;
      applyLogFilter();
    }

    function formatTokenExpiryLocal(ts){
      if (!ts) return '(unknown)';
      try {
        const d = new Date(Number(ts) * 1000);
        return d.toLocaleString(undefined, { year:'numeric', month:'2-digit', day:'2-digit', hour:'2-digit', minute:'2-digit' });
      } catch (e) {
        return String(ts);
      }
    }

    function _tokenStatus(ts){
      const n = Number(ts || 0);
      if (!n || Number.isNaN(n)) return { state: 'unknown' };

      const now = Date.now();
      const exp = n * 1000;
      const mins = Math.round((exp - now) / 60000);

      if (exp <= now) return { state: 'expired', mins };
      if (mins <= 30) return { state: 'soon', mins };
      return { state: 'valid', mins };
    }

    function setOauthStatus(ts){
      const iconWrap = document.getElementById('oauthStatusIcon');
      const text = document.getElementById('oauthStatusText');
      const refreshBtn = document.getElementById('oauthRefreshBtn');
      if (!text || !iconWrap) return;

      const st = _tokenStatus(ts);
      if (refreshBtn) {
        // User requirement: if expired, refresh is disabled (force reauth/device-flow).
        refreshBtn.disabled = (st.state === 'expired' || st.state === 'unknown');
      }

      if (st.state === 'unknown') {
        text.textContent = 'Unknown';
        iconWrap.innerHTML = '<i data-lucide="help-circle" class="h-5 w-5"></i>';
      } else if (st.state === 'expired') {
        text.textContent = 'Expired';
        iconWrap.innerHTML = '<i data-lucide="badge-alert" class="h-5 w-5 text-red-600"></i>';
      } else if (st.state === 'soon') {
        text.textContent = `Expiring soon (${st.mins} min)`;
        iconWrap.innerHTML = '<i data-lucide="badge-alert" class="h-5 w-5 text-amber-500"></i>';
      } else {
        text.textContent = `Valid (${st.mins} min)`;
        iconWrap.innerHTML = '<i data-lucide="badge-check" class="h-5 w-5 text-emerald-600"></i>';
      }

      try { lucide.createIcons(); } catch(e) {}
    }

    function setTokenCardStatus(ts){
      const card = document.getElementById('tokenCard');
      const hint = document.getElementById('tokenHint');
      const icon = document.getElementById('tokenCardIcon');
      const headerChip = document.getElementById('headerTokenChip');
      if (!card || !hint || !icon) return;

      const st = _tokenStatus(ts);

      if (headerChip) headerChip.classList.toggle('hidden', st.state !== 'expired');

      // reset
      card.classList.remove('bg-red-50','border-red-200','bg-amber-50','border-amber-200');
      card.classList.remove('dark:bg-red-950/30','dark:border-red-900/40','dark:bg-amber-950/25','dark:border-amber-900/40');
      hint.classList.remove('text-red-700','text-amber-700');
      icon.innerHTML = '<i data-lucide="key-round" class="h-4 w-4"></i>';

      if (st.state === 'expired') {
        card.classList.add('bg-red-50','border-red-200','dark:bg-red-950/30','dark:border-red-900/40');
        hint.classList.add('text-red-700');
        hint.textContent = 'Token expired — re-authenticate via OAuth device flow.';
        icon.innerHTML = '<i data-lucide="triangle-alert" class="h-4 w-4 text-red-600"></i>';
      } else if (st.state === 'soon') {
        card.classList.add('bg-amber-50','border-amber-200','dark:bg-amber-950/25','dark:border-amber-900/40');
        hint.classList.add('text-amber-700');
        hint.textContent = `Token expiring soon (${st.mins} min) — consider refreshing.`;
        icon.innerHTML = '<i data-lucide="triangle-alert" class="h-4 w-4 text-amber-500"></i>';
      } else if (st.state === 'valid') {
        hint.textContent = `Token valid (${st.mins} min left) — shown in your local time.`;
        icon.innerHTML = '<i data-lucide="badge-check" class="h-4 w-4 text-emerald-600"></i>';
      } else {
        hint.textContent = 'shown in your local time';
        icon.innerHTML = '<i data-lucide="help-circle" class="h-4 w-4"></i>';
      }

      try { lucide.createIcons(); } catch(e) {}
    }

    function syncTokenExpiryFromDom(){
      const te = document.getElementById('tokenExp');
      if (te) {
        const ts = te.getAttribute('data-ts');
        te.textContent = formatTokenExpiryLocal(ts);
        setTokenCardStatus(ts);
      }
      const oe = document.getElementById('oauthTokenExp');
      if (oe) {
        const ts = oe.getAttribute('data-ts');
        oe.textContent = formatTokenExpiryLocal(ts);
        setOauthStatus(ts);
      }
    }

    function _extractLastRefresh(log){
      // log lines look like: [YYYY-MM-DD HH:MM:SS] refresh_token\n...\nToken refresh succeeded.
      const s = String(log || '');
      const blocks = s.trim().split(/\n\[(?=\d{4}-\d{2}-\d{2} )/g);
      const last = blocks[blocks.length-1] || '';
      const m = last.match(/\[(\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2})\]/);
      const ts = m ? m[1] : null;
      const ok = /succeeded/i.test(last) && !/failed/i.test(last);
      return { ts, ok, raw: last };
    }

    async function refreshStatus(){
      try {
        const r = await fetch('/api/status', { cache: 'no-store' });
        const j = await r.json();

        // pending
        if (typeof j.pending !== 'undefined') syncPendingFromApi(!!j.pending);

        // health
        const dot = document.getElementById('healthDot');
        const lbl = document.getElementById('healthLabel');
        if (dot) {
          dot.classList.toggle('bg-emerald-500', !!j.ok);
          dot.classList.toggle('bg-red-500', !j.ok);
        }
        if (lbl) lbl.textContent = j.ok ? 'Postfix OK' : 'Postfix not reachable';

        // header health chip
        const hd = document.getElementById('headerHealthDot');
        const ht = document.getElementById('headerHealthText');
        if (hd) {
          hd.classList.toggle('bg-emerald-500', !!j.ok);
          hd.classList.toggle('bg-red-500', !j.ok);
        }
        if (ht) ht.textContent = j.ok ? 'Postfix OK' : 'Postfix not reachable';

        // cards
        const qs = document.getElementById('queueSize');
        if (qs && typeof j.queue_size !== 'undefined') qs.textContent = String(j.queue_size);
        const rh = document.getElementById('relayhost');
        if (rh && j.env?.RELAYHOST) rh.textContent = j.env.RELAYHOST;
        const mu = document.getElementById('ms365User');
        if (mu && j.env?.MS365_SMTP_USER) mu.textContent = j.env.MS365_SMTP_USER;
        const te = document.getElementById('tokenExp');
        if (te) {
          te.setAttribute('data-ts', j.token_exp_ts || '');
          te.textContent = formatTokenExpiryLocal(j.token_exp_ts);
          setTokenCardStatus(j.token_exp_ts);
        }
        const oe = document.getElementById('oauthTokenExp');
        if (oe) {
          oe.setAttribute('data-ts', j.token_exp_ts || '');
          oe.textContent = formatTokenExpiryLocal(j.token_exp_ts);
          setOauthStatus(j.token_exp_ts);
        }

        // warn tail
        const wt = document.getElementById('warnTail');
        if (wt) wt.textContent = j.mail_log_warn || '(none)';

        // queue
        const mq1 = document.getElementById('mailqPre');
        const mq2 = document.getElementById('mailqPre2');
        if (mq1) mq1.textContent = j.mailq || '';
        if (mq2) mq2.textContent = j.mailq || '';

        // mail log (keep fulltext for filtering)
        const ml = document.getElementById('mailLogPre');
        if (ml) {
          // store as JSON so escaping doesn't break filtering
          ml.setAttribute('data-fulljson', JSON.stringify(j.mail_log || ''));
          applyLogFilter();
        }

        // last refresh indicator
        const lr = document.getElementById('oauthLastRefresh');
        if (lr && typeof j.token_refresh_log !== 'undefined') {
          const info = _extractLastRefresh(j.token_refresh_log || '');
          if (info.ts) {
            lr.textContent = info.ts + (info.ok ? ' (ok)' : ' (check log)');
          } else {
            lr.textContent = '(unknown)';
          }
        }

        // From identities: keep dropdown usable on refresh
        const sel = document.getElementById('fromSelect');
        if (sel && Array.isArray(j.from_identities)) {
          const current = sel.value;
          // Rebuild options
          sel.innerHTML = '<option value="">Custom…</option>' + j.from_identities.map(a => `<option value="${a}">${a}</option>`).join('');
          // try restore
          for (const opt of sel.options) {
            if (opt.value === current) { sel.value = current; break; }
          }
        }

      } catch (e) {
        // ignore
      }
    }

    function initAutoRefresh(){
      const key = 'ms365-relay-autorefresh';
      const cb = document.getElementById('autoRefresh');
      if (!cb) return;
      cb.checked = (localStorage.getItem(key) === '1');
      let timer = null;

      function start(){
        if (timer) return;
        timer = window.setInterval(refreshStatus, 5000);
      }
      function stop(){
        if (!timer) return;
        window.clearInterval(timer);
        timer = null;
      }

      cb.addEventListener('change', () => {
        localStorage.setItem(key, cb.checked ? '1' : '0');
        if (cb.checked) { refreshStatus(); start(); } else { stop(); }
      });

      const btn = document.getElementById('refreshBtn');
      if (btn) btn.addEventListener('click', () => refreshStatus());

      if (cb.checked) { refreshStatus(); start(); }
    }

    function syncPendingFromApi(pending){
      const btn = document.getElementById('applyBtn');
      if (btn) btn.disabled = !pending;

      const banner = document.getElementById('pendingBanner');
      if (banner) banner.classList.toggle('hidden', !pending);

      const chip = document.getElementById('headerPendingChip');
      if (chip) chip.classList.toggle('hidden', !pending);

      // health chip
      const hd = document.getElementById('headerHealthDot');
      const ht = document.getElementById('headerHealthText');
      // updated elsewhere in refreshStatus
    }

    async function saveSettingsNoReload(){
      const form = document.getElementById('settingsForm');
      if (!form) return;
      try {
        const data = new FormData(form);
        const r = await fetch('/api/settings', { method: 'POST', body: data });
        const j = await r.json();
        if (j && j.ok) {
          showToast('Saved (not applied). Click Apply Changes.', 'ok');
          if (typeof j.pending !== 'undefined') syncPendingFromApi(!!j.pending);
        } else {
          showToast('Save failed.', 'error');
        }
      } catch (e) {
        showToast('Save failed.', 'error');
      }
    }

    async function startDeviceFlowNoReload(){
      showToast('Starting device flow…', 'ok');
      // hide previous callout
      document.getElementById('deviceFlowCallout')?.classList.add('hidden');
      try {
        await fetch('/api/token/start', { method: 'POST' });
      } catch (e) {
        showToast('Failed to start device flow.', 'error');
        return;
      }

      // Poll log until we see code + url
      const started = Date.now();
      while (Date.now() - started < 30000) {
        try {
          const r = await fetch('/api/device-flow-log', { cache: 'no-store' });
          const j = await r.json();
          const log = j.log || '';
          const m = log.match(/open the page\s+(https?:\/\/\S+)\s+and enter the code\s+([A-Z0-9]+)/i);
          if (m) {
            const url = m[1];
            const code = m[2];
            const a = document.getElementById('deviceFlowUrl');
            const c = document.getElementById('deviceFlowCode');
            if (a) { a.href = url; a.textContent = url; }
            if (c) { c.textContent = code; }
            document.getElementById('deviceFlowCallout')?.classList.remove('hidden');
            showToast('Device flow started. Use the code shown in OAuth section.', 'ok');
            try { lucide.createIcons(); } catch(e) {}
            return;
          }
        } catch (e) {}
        await new Promise(res => setTimeout(res, 1000));
      }

      showToast('Device flow started. Check the log for the code.', 'ok');
    }

    async function refreshTokenNoReload(){
      try {
        const r = await fetch('/api/token/refresh', { method: 'POST' });
        const j = await r.json();
        const out = (j.output || '').trim();
        const ok = !(out && out.toLowerCase().includes('failed'));

        if (!ok) {
          showToast('Token refresh failed.', 'error');
          return;
        }

        // Update expiry immediately if backend provided it
        if (typeof j.token_exp_ts !== 'undefined' && j.token_exp_ts) {
          const te = document.getElementById('tokenExp');
          if (te) {
            te.setAttribute('data-ts', j.token_exp_ts);
            te.textContent = formatTokenExpiryLocal(j.token_exp_ts);
            setTokenCardStatus(j.token_exp_ts);
          }
          const oe = document.getElementById('oauthTokenExp');
          if (oe) {
            oe.setAttribute('data-ts', j.token_exp_ts);
            oe.textContent = formatTokenExpiryLocal(j.token_exp_ts);
            setOauthStatus(j.token_exp_ts);
          }
        }

        showToast('Token refreshed.', 'ok');

        // Always re-sync full status after refresh
        await refreshStatus();
      } catch (e) {
        showToast('Token refresh failed.', 'error');
      }
    }

    async function refreshUsersSection(){
      try {
        const r = await fetch('/api/users', { cache: 'no-store' });
        const j = await r.json();
        const pre = document.getElementById('usersPre');
        if (pre && j && typeof j.users !== 'undefined') pre.textContent = j.users || '';
      } catch (e) {}
    }

    async function usersAddNoReload(){
      const form = document.getElementById('usersAddForm');
      if (!form) return;
      try {
        const data = new FormData(form);
        const r = await fetch('/api/users/add', { method: 'POST', body: data });
        const j = await r.json();
        if (j && j.ok) {
          showToast('User saved.', 'ok');
          form.reset();
          await refreshUsersSection();
        } else {
          showToast('Failed to save user.', 'error');
        }
      } catch (e) {
        showToast('Failed to save user.', 'error');
      }
    }

    async function usersDeleteNoReload(){
      const form = document.getElementById('usersDeleteForm');
      if (!form) return;
      try {
        const data = new FormData(form);
        const r = await fetch('/api/users/delete', { method: 'POST', body: data });
        const j = await r.json();
        if (j && j.ok) {
          showToast('User deleted.', 'ok');
          form.reset();
          await refreshUsersSection();
        } else {
          showToast('Failed to delete user.', 'error');
        }
      } catch (e) {
        showToast('Failed to delete user.', 'error');
      }
    }

    function _escapeHtml(s){
      return String(s || '').replace(/[&<>"']/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    async function refreshSendersSection(){
      try {
        const r = await fetch('/api/senders', { cache: 'no-store' });
        const j = await r.json();
        if (!j || !j.ok) return;
        if (typeof j.pending !== 'undefined') syncPendingFromApi(!!j.pending);

        const body = document.getElementById('sendersTableBody');
        if (!body) return;

        const allowed = j.allowed_from || {};
        const defFrom = j.default_from || {};

        const logins = Object.keys(allowed);
        if (!logins.length) {
          body.innerHTML = '<div class="px-3 py-4 text-sm text-slate-500 dark:text-slate-400">No sender rules configured yet.</div>';
          return;
        }

        const rows = [];
        for (const login of logins) {
          const addrs = allowed[login] || [];
          const df = defFrom[login] || '';

          let rhs = '';
          if (!addrs.length) {
            rhs = '<div class="text-sm text-slate-500 dark:text-slate-400">(none)</div>';
          } else {
            const chips = addrs.map(a => {
              const aa = _escapeHtml(a);
              const ll = _escapeHtml(login);
              return `
                <button type="button" class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" title="Click to remove" onclick="disallowFrom('${ll}','${aa}')">
                  <i data-lucide="x" class="h-3.5 w-3.5"></i>
                  <span class="mono">${aa}</span>
                </button>`;
            }).join('');
            rhs = `<div class="flex flex-wrap gap-2">${chips}</div>`;
          }

          rows.push(`
            <div class="grid grid-cols-12 gap-2 px-3 py-3">
              <div class="col-span-12 sm:col-span-4">
                <div class="text-sm font-semibold">${_escapeHtml(login)}</div>
                ${df ? `<div class="mt-1 text-xs text-slate-500 dark:text-slate-400">Default From: <span class="mono">${_escapeHtml(df)}</span></div>` : ''}
              </div>
              <div class="col-span-12 sm:col-span-8">${rhs}</div>
            </div>
          `);
        }

        body.innerHTML = rows.join('');
        try { lucide.createIcons(); } catch(e) {}
      } catch (e) {}
    }

    async function allowFromNoReload(){
      const form = document.getElementById('fromAllowForm');
      if (!form) return;
      try {
        const data = new FormData(form);
        const r = await fetch('/api/from/allow', { method: 'POST', body: data });
        const j = await r.json();
        if (j && j.ok) {
          showToast('Saved (not applied). Click Apply Changes.', 'ok');
          if (typeof j.pending !== 'undefined') syncPendingFromApi(!!j.pending);
          form.reset();
          await refreshSendersSection();
          await refreshStatus();
        } else {
          showToast('Save failed.', 'error');
        }
      } catch (e) {
        showToast('Save failed.', 'error');
      }
    }

    async function defaultFromNoReload(){
      const form = document.getElementById('defaultFromForm');
      if (!form) return;
      try {
        const data = new FormData(form);
        const r = await fetch('/api/from/default', { method: 'POST', body: data });
        const j = await r.json();
        if (j && j.ok) {
          showToast('Saved (not applied). Click Apply Changes.', 'ok');
          if (typeof j.pending !== 'undefined') syncPendingFromApi(!!j.pending);
          await refreshSendersSection();
          await refreshStatus();
        } else {
          showToast('Save failed.', 'error');
        }
      } catch (e) {
        showToast('Save failed.', 'error');
      }
    }

    async function testmailNoReload(){
      const form = document.getElementById('testmailForm');
      if (!form) return;
      const btn = document.getElementById('testmailBtn');
      if (btn) btn.disabled = true;
      try {
        const data = new FormData(form);
        const r = await fetch('/api/testmail', { method: 'POST', body: data });
        const j = await r.json();
        const out = (j.output || '').trim() || 'ok';
        const pre = document.getElementById('testmailOut');
        if (pre) pre.textContent = out;
        showToast(out.length > 120 ? (out.slice(0,120) + '…') : out, j.level === 'error' ? 'error' : 'ok');
        await refreshStatus();
      } catch (e) {
        showToast('Send test mail failed.', 'error');
      } finally {
        if (btn) btn.disabled = false;
      }
    }

    async function disallowFrom(login, fromAddr){
      try {
        const data = new FormData();
        data.set('login', login);
        data.set('from_addr', fromAddr);
        const r = await fetch('/api/from/disallow', { method: 'POST', body: data });
        const j = await r.json();
        if (j && j.ok) {
          showToast('Saved (not applied). Click Apply Changes.', 'ok');
          if (typeof j.pending !== 'undefined') syncPendingFromApi(!!j.pending);
          await refreshSendersSection();
          await refreshStatus();
        } else {
          showToast('Save failed.', 'error');
        }
      } catch (e) {
        showToast('Save failed.', 'error');
      }
    }

    function initUsersAjax(){
      const a = document.getElementById('usersAddForm');
      if (a) a.addEventListener('submit', (e) => { e.preventDefault(); usersAddNoReload(); });
      const d = document.getElementById('usersDeleteForm');
      if (d) d.addEventListener('submit', (e) => { e.preventDefault(); usersDeleteNoReload(); });
    }

    function initSendersAjax(){
      const f = document.getElementById('fromAllowForm');
      if (f) f.addEventListener('submit', (e) => { e.preventDefault(); allowFromNoReload(); });
      const d = document.getElementById('defaultFromForm');
      if (d) d.addEventListener('submit', (e) => { e.preventDefault(); defaultFromNoReload(); });

      // disallow handled via onclick buttons after we render (and initial HTML still has forms, but those will submit normally).
      // To prevent page reload on initial-render disallow forms, intercept submit events in the senders section.
      const container = document.getElementById('senders');
      if (container) {
        container.addEventListener('submit', (e) => {
          const form = e.target;
          if (!form || form.tagName !== 'FORM') return;
          const action = form.getAttribute('action') || '';
          if (action !== '/from/disallow') return;
          e.preventDefault();
          const fd = new FormData(form);
          disallowFrom(fd.get('login') || '', fd.get('from_addr') || '');
        }, true);
      }
    }

    async function applyNoReload(){
      const btn = document.getElementById('applyBtn');
      if (btn) btn.disabled = true;
      try {
        const r = await fetch('/api/apply', { method: 'POST' });
        const j = await r.json();
        const out = (j.output || '').trim() || 'ok';
        showToast('Applied changes.', j.level === 'error' ? 'error' : 'ok');
        syncPendingFromApi(false);
        await refreshStatus();
      } catch (e) {
        showToast('Apply failed.', 'error');
      } finally {
        // keep disabled state correct after refreshStatus
      }
    }

    function initApplyAjax(){
      const f = document.getElementById('applyForm');
      if (f) f.addEventListener('submit', (e) => { e.preventDefault(); applyNoReload(); });
    }

    function initTestmailAjax(){
      const t = document.getElementById('testmailForm');
      if (t) t.addEventListener('submit', (e) => { e.preventDefault(); testmailNoReload(); });
    }

    function initOauthAjax(){
      const rf = document.getElementById('oauthRefreshForm');
      if (rf) rf.addEventListener('submit', (e) => { e.preventDefault(); refreshTokenNoReload(); });
      const af = document.getElementById('oauthReauthForm');
      if (af) af.addEventListener('submit', (e) => { e.preventDefault(); startDeviceFlowNoReload(); });
    }

    function initSettingsAjax(){
      const form = document.getElementById('settingsForm');
      if (!form) return;
      form.addEventListener('submit', (e) => {
        // progressive enhancement: prevent full reload
        e.preventDefault();
        saveSettingsNoReload();
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      try { lucide.createIcons(); } catch(e) {}
      syncThemeButton();
      initNavClicks();
      initScrollSpy();
      showToastFromUrl();
      initAutoRefresh();
      initSettingsAjax();
      initOauthAjax();
      initUsersAjax();
      initSendersAjax();
      initTestmailAjax();
      initApplyAjax();
      syncTokenExpiryFromDom();
      applyLogFilter();
    });
  </script>

  <style>
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }

    /* toast */
    #toast {
      box-shadow: 0 12px 30px var(--shadow);
      border: 1px solid var(--border);
      background: var(--card);
      color: var(--fg);
    }
    #toast.toast-error {
      border-color: color-mix(in oklab, #ef4444 35%, var(--border));
      background: color-mix(in oklab, #ef4444 10%, var(--card));
    }

    /*
      Tailwind CDN config isn't reliably applied in some setups (tailwind.config ends up {}).
      So we implement dark/light via CSS variables + a few class overrides.
      This keeps the layout utilities from Tailwind, but makes colors follow html.dark.
    */
    :root {
      --bg: #f8fafc;            /* slate-50 */
      --fg: #0f172a;            /* slate-900 */
      --muted: #475569;         /* slate-600 */
      --muted2: #64748b;        /* slate-500 */
      --card: #ffffff;
      --card2: #f1f5f9;         /* slate-100 */
      --border: #e2e8f0;        /* slate-200 */
      --border2: #cbd5e1;       /* slate-300 */
      --shadow: rgba(2,6,23,0.06);
    }
    html.dark {
      --bg: #020617;            /* slate-950 */
      --fg: #e2e8f0;            /* slate-200 */
      --muted: #94a3b8;         /* slate-400 */
      --muted2: #94a3b8;
      --card: #0b1220;          /* slightly above slate-950 */
      --card2: #0f172a;         /* slate-900 */
      --border: #1f2937;        /* gray-800-ish */
      --border2: #334155;       /* slate-700 */
      --shadow: rgba(0,0,0,0.35);
    }

    body { background: var(--bg) !important; color: var(--fg) !important; }

    /* common Tailwind color classes used in this template */
    .bg-white { background-color: var(--card) !important; }
    .bg-slate-50 { background-color: var(--bg) !important; }
    .bg-slate-900 { background-color: var(--card2) !important; }
    .bg-slate-950 { background-color: var(--bg) !important; }

    .text-slate-900 { color: var(--fg) !important; }
    .text-slate-700 { color: var(--fg) !important; opacity: 0.92; }
    .text-slate-600 { color: var(--muted) !important; }
    .text-slate-500 { color: var(--muted2) !important; }
    .text-slate-200 { color: var(--fg) !important; }

    .border-slate-200 { border-color: var(--border) !important; }
    .border-slate-800 { border-color: var(--border) !important; }

    /* subtle hover for nav items */
    a[data-nav]:hover { background-color: var(--card2) !important; }

    /* active nav item styling */
    a[data-nav].is-active {
      background: color-mix(in oklab, #2563eb 14%, var(--card)) !important; /* blue tint */
      border: 1px solid color-mix(in oklab, #2563eb 28%, var(--border)) !important;
      color: var(--fg) !important;
    }

    /* topbar translucent background */
    header { background-color: color-mix(in oklab, var(--card) 82%, transparent) !important; }

    /* pre blocks */
    pre { background: color-mix(in oklab, var(--card2) 80%, var(--card) 20%) !important; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100">
  <div class="min-h-full">

    <!-- Top bar -->

    <!-- Toast -->
    <div id="toast" class="hidden fixed right-4 top-20 z-50 max-w-xl rounded-2xl px-4 py-3 text-sm">
      <div class="flex items-start gap-3">
        <div class="mt-0.5">
          <i data-lucide="info" class="h-4 w-4"></i>
        </div>
        <div class="flex-1">
          <div class="font-semibold">Notice</div>
          <div id="toastText" class="mt-0.5 whitespace-pre-wrap text-xs opacity-90"></div>
        </div>
        <button type="button" onclick="document.getElementById('toast').classList.add('hidden')" class="rounded-lg px-2 py-1 opacity-70 hover:opacity-100">
          <i data-lucide="x" class="h-4 w-4"></i>
        </button>
      </div>
    </div>

    <!-- Pending changes banner -->
    <div id="pendingBanner" class="fixed inset-x-0 bottom-4 z-40 mx-auto max-w-4xl px-4 {% if not pending %}hidden{% endif %}">
      <div class="flex flex-col gap-3 rounded-2xl border border-amber-200 bg-amber-50 px-4 py-3 shadow-lg dark:border-amber-900/40 dark:bg-amber-950 sm:flex-row sm:items-center sm:justify-between">
        <div class="flex items-start gap-3">
          <div class="mt-0.5 text-amber-700 dark:text-amber-300">
            <i data-lucide="triangle-alert" class="h-5 w-5"></i>
          </div>
          <div>
            <div class="text-sm font-semibold text-amber-900 dark:text-amber-200">Changes saved, not applied</div>
            <div class="mt-0.5 text-xs text-amber-800 dark:text-amber-300">Postfix is still running with the old config. Click <span class="font-semibold">Apply Changes</span> to regenerate config + reload Postfix.</div>
          </div>
        </div>
        <div class="flex flex-wrap gap-2">
          <form method="post" action="/apply">
            <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500" title="Applies saved settings: regenerate Postfix config + reload Postfix">
              <i data-lucide="check-circle" class="h-4 w-4"></i>
              Apply Changes
            </button>
          </form>
          <button type="button" onclick="document.getElementById('pendingBanner')?.remove()" class="inline-flex items-center gap-2 rounded-xl border border-amber-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-amber-100 dark:border-amber-900/40 dark:bg-slate-950 dark:hover:bg-amber-950/30" title="Dismiss">
            <i data-lucide="x" class="h-4 w-4"></i>
            Dismiss
          </button>
        </div>
      </div>
    </div>

    <header class="sticky top-0 z-30 border-b border-slate-200 bg-white/80 backdrop-blur dark:border-slate-800 dark:bg-slate-950/70">
      <div class="mx-auto flex max-w-7xl items-center justify-between px-4 py-3 sm:px-6 lg:px-8">
        <div class="flex items-center gap-3">
          <div class="flex h-9 w-9 items-center justify-center rounded-xl bg-blue-600 text-white">
            <i data-lucide="mail" class="h-5 w-5"></i>
          </div>
          <div>
            <div class="text-sm font-semibold leading-5">ms365-relay</div>
            <div class="text-xs text-slate-500 dark:text-slate-400">Postfix → Microsoft 365 (XOAUTH2)</div>
          </div>
        </div>

        <div class="flex items-center gap-2">
          <div class="hidden items-center gap-2 sm:flex">
            <span id="headerHealthChip" class="inline-flex items-center gap-2 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-200">
              <span id="headerHealthDot" class="h-2 w-2 rounded-full {{ 'bg-emerald-500' if postfix_ok else 'bg-red-500' }}"></span>
              <span id="headerHealthText">{{ 'Postfix OK' if postfix_ok else 'Postfix not reachable' }}</span>
            </span>

            <span id="headerPendingChip" class="inline-flex items-center gap-2 rounded-full border border-amber-200 bg-amber-50 px-3 py-1.5 text-xs font-semibold text-amber-900 shadow-sm dark:border-amber-900/40 dark:bg-amber-950 dark:text-amber-200 {% if not pending %}hidden{% endif %}">
              <i data-lucide="triangle-alert" class="h-3.5 w-3.5"></i>
              Pending changes
            </span>

            <span id="headerTokenChip" class="hidden inline-flex items-center gap-2 rounded-full border border-red-200 bg-red-50 px-3 py-1.5 text-xs font-semibold text-red-900 shadow-sm dark:border-red-900/40 dark:bg-red-950 dark:text-red-200" title="OAuth token expired">
              <i data-lucide="badge-alert" class="h-3.5 w-3.5"></i>
              Token expired
            </span>
          </div>

          <button id="themeBtn" type="button" onclick="toggleTheme()"
            class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-medium shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800">
            <i data-lucide="moon" class="h-4 w-4"></i>
            <span id="themeBtnLabel">Dark</span>
          </button>
        </div>
      </div>
    </header>

    <main class="mx-auto grid max-w-7xl grid-cols-1 gap-6 px-4 py-6 sm:px-6 lg:grid-cols-12 lg:px-8">

      <!-- Sidebar -->
      <aside class="lg:col-span-3">
        <div class="sticky top-[4.75rem] self-start">
        <nav class="space-y-1">
          <a data-nav href="#status" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="activity" class="h-4 w-4"></i> Status
          </a>
          <a data-nav href="#settings" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="settings" class="h-4 w-4"></i> Settings
          </a>
          <a data-nav href="#users" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="users" class="h-4 w-4"></i> Users
          </a>
          <a data-nav href="#senders" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="at-sign" class="h-4 w-4"></i> Allowed From
          </a>
          <a data-nav href="#oauth" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="key-round" class="h-4 w-4"></i> OAuth
          </a>
          <a data-nav href="#testmail" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="send" class="h-4 w-4"></i> Test mail
          </a>
          <a data-nav href="#logs" class="flex items-center gap-3 rounded-xl px-3 py-2 text-sm font-medium text-slate-700 hover:bg-slate-100 dark:text-slate-200 dark:hover:bg-slate-800">
            <i data-lucide="scroll-text" class="h-4 w-4"></i> Logs
          </a>
        </nav>

        <div class="mt-6 rounded-2xl border border-slate-200 bg-white p-4 text-xs text-slate-600 shadow-sm dark:border-slate-800 dark:bg-slate-900 dark:text-slate-300">
          <div class="flex items-start gap-2">
            <i data-lucide="shield-alert" class="mt-0.5 h-4 w-4"></i>
            <div>
              <div class="font-semibold text-slate-700 dark:text-slate-200">Security</div>
              <div class="mt-1">This UI intentionally has <span class="font-semibold">no built-in auth</span>. Put it behind a reverse proxy (basic auth / SSO / VPN).</div>
              <div class="mt-2 flex flex-wrap gap-2">
                <a href="#settings" class="inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-white px-2 py-1 text-[11px] font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800">
                  <i data-lucide="settings" class="h-3.5 w-3.5"></i>
                  Check trusted subnets
                </a>
                <a href="/diagnostics.txt" class="inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-white px-2 py-1 text-[11px] font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800">
                  <i data-lucide="download" class="h-3.5 w-3.5"></i>
                  Diagnostics
                </a>
              </div>
            </div>
          </div>
        </div>
        </div>
      </aside>

      <!-- Content -->
      <section class="space-y-6 lg:col-span-9">

        <!-- STATUS -->
        <div id="status" class="scroll-mt-24">
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div>
              <h2 class="text-lg font-semibold">Status</h2>
              <div class="mt-1 flex items-center gap-2 text-xs text-slate-500 dark:text-slate-400">
                <span class="inline-flex items-center gap-2">
                  <span id="healthDot" class="h-2 w-2 rounded-full {{ 'bg-emerald-500' if postfix_ok else 'bg-red-500' }}"></span>
                  <span id="healthLabel">{{ 'Postfix OK' if postfix_ok else 'Postfix not reachable' }}</span>
                </span>
                <span class="opacity-40">•</span>
                <a href="/diagnostics.txt" class="inline-flex items-center gap-1 hover:underline" title="Download diagnostics (no tokens)">
                  <i data-lucide="download" class="h-3.5 w-3.5"></i> Diagnostics
                </a>
              </div>
            </div>

            <div class="flex flex-wrap items-center gap-2">
              <button type="button" id="refreshBtn" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800">
                <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                Refresh
              </button>

              <label class="inline-flex cursor-pointer items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800" title="Auto refresh status + logs">
                <input id="autoRefresh" type="checkbox" class="h-4 w-4" />
                Auto refresh
              </label>

              <form method="post" action="/apply">
                <button type="submit" id="applyBtn" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-50" title="Applies saved settings: regenerate Postfix config + reload Postfix" {% if not pending %}disabled{% endif %}>
                  <i data-lucide="check-circle" class="h-4 w-4"></i>
                  Apply Changes
                </button>
              </form>
              <form method="post" action="/postfix/reload">
                <button type="submit" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800" title="Reloads Postfix (keeps current config)">
                  <i data-lucide="rotate-cw" class="h-4 w-4"></i>
                  Reload
                </button>
              </form>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2 lg:grid-cols-4">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="flex items-center justify-between">
                <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Queue</div>
                <i data-lucide="inbox" class="h-4 w-4 text-slate-400"></i>
              </div>
              <div class="mt-1 text-2xl font-semibold" id="queueSize">{{ queue_size }}</div>
              <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">messages waiting</div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="flex items-center justify-between">
                <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Relayhost</div>
                <i data-lucide="server" class="h-4 w-4 text-slate-400"></i>
              </div>
              <div class="mt-1 truncate text-sm font-semibold" id="relayhost" title="{{ env.RELAYHOST }}">{{ env.RELAYHOST }}</div>
              <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">M365 SMTP endpoint</div>
            </div>
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="flex items-center justify-between">
                <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">M365 user</div>
                <i data-lucide="user-round" class="h-4 w-4 text-slate-400"></i>
              </div>
              <div class="mt-1 truncate text-sm font-semibold" id="ms365User" title="{{ env.MS365_SMTP_USER }}">{{ env.MS365_SMTP_USER }}</div>
              <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">authenticated sender</div>
            </div>
            <div id="tokenCard" class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="flex items-center justify-between">
                <div class="text-xs font-medium uppercase tracking-wide text-slate-500 dark:text-slate-400">Token expiry</div>
                <span id="tokenCardIcon" class="text-slate-400"><i data-lucide="key-round" class="h-4 w-4"></i></span>
              </div>
              <div class="mt-1 text-sm font-semibold" id="tokenExp" data-ts="{{ token_exp_ts or '' }}">(loading…)</div>
              <div class="mt-1 text-xs text-slate-500 dark:text-slate-400" id="tokenHint">shown in your local time</div>
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Recent warnings / errors</div>
                <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" onclick="copyText('warnTail')">
                  <i data-lucide="copy" class="h-3.5 w-3.5"></i>
                  Copy
                </button>
              </div>
              <pre id="warnTail" class="mono mt-2 max-h-48 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs dark:border-slate-800 dark:bg-slate-950">{{ mail_log_warn or "(none)" }}</pre>
            </div>

            <div class="rounded-2xl border border-slate-200 bg-white p-4 shadow-sm dark:border-slate-800 dark:bg-slate-900">
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Queue (mailq)</div>
                <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" onclick="copyText('mailqPre')">
                  <i data-lucide="copy" class="h-3.5 w-3.5"></i>
                  Copy
                </button>
              </div>
              <pre id="mailqPre" class="mono mt-2 max-h-48 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs dark:border-slate-800 dark:bg-slate-950">{{ mailq or "" }}</pre>
            </div>
          </div>

        </div>

        <!-- SETTINGS -->
        <div id="settings" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="settings" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">Settings</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Hostname + trusted subnets (mynetworks).</p>

          <form id="settingsForm" method="post" action="/settings" class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <div>
              <label class="text-sm font-medium">Hostname</label>
              <input name="hostname" value="{{ cfg.hostname }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div>
              <label class="text-sm font-medium">Domain</label>
              <input name="domain" value="{{ cfg.domain }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm font-medium">Trusted subnets (mynetworks; space/comma separated)</label>
              <input name="mynetworks" value="{{ (cfg.mynetworks or []) | join(' ') }}" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div class="sm:col-span-2 flex justify-end">
              <button type="submit" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500">
                <i data-lucide="save" class="h-4 w-4"></i>
                Save settings
              </button>
            </div>
          </form>

          <div class="mt-4 rounded-xl bg-slate-50 p-3 text-xs text-slate-600 dark:bg-slate-950 dark:text-slate-300">
            Ports/TLS and M365 OAuth settings are controlled by environment variables (compose).
          </div>
        </div>

        <!-- USERS -->
        <div id="users" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="users" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">SMTP AUTH users</h2>
          </div>

          <div class="mt-3 rounded-xl border border-slate-200 bg-slate-50 p-3 dark:border-slate-800 dark:bg-slate-950">
            <pre id="usersPre" class="mono max-h-56 overflow-auto text-xs">{{ users }}</pre>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <form id="usersAddForm" method="post" action="/users/add" class="space-y-2">
              <div class="text-sm font-medium">Add / update</div>
              <input name="login" placeholder="username" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <input name="password" placeholder="password" type="password" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-500">
                <i data-lucide="user-plus" class="h-4 w-4"></i>
                Save
              </button>
            </form>

            <form id="usersDeleteForm" method="post" action="/users/delete" class="space-y-2">
              <div class="text-sm font-medium">Delete</div>
              <input name="login" placeholder="username" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-red-200 bg-white px-3 py-2 text-sm font-semibold text-red-700 hover:bg-red-50 dark:border-red-900/40 dark:bg-slate-950 dark:text-red-300 dark:hover:bg-red-950/40">
                <i data-lucide="trash-2" class="h-4 w-4"></i>
                Delete
              </button>
            </form>
          </div>
        </div>

        <!-- SENDERS -->
        <div id="senders" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="at-sign" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">Allowed From addresses</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">
            Enforced via <span class="mono">smtpd_sender_login_maps</span> + <span class="mono">reject_sender_login_mismatch</span>.
          </p>

          <div class="mt-3 overflow-hidden rounded-xl border border-slate-200 bg-white dark:border-slate-800 dark:bg-slate-950">
            <div class="grid grid-cols-12 border-b border-slate-200 bg-slate-50 px-3 py-2 text-xs font-semibold text-slate-600 dark:border-slate-800 dark:bg-slate-900/40 dark:text-slate-300">
              <div class="col-span-4">SMTP user</div>
              <div class="col-span-8">Allowed From addresses</div>
            </div>
            <div id="sendersTableBody" class="divide-y divide-slate-200 dark:divide-slate-800">
              {% for login, addrs in (cfg.allowed_from or {}).items() %}
                <div class="grid grid-cols-12 gap-2 px-3 py-3">
                  <div class="col-span-12 sm:col-span-4">
                    <div class="text-sm font-semibold">{{ login }}</div>
                    {% if (cfg.default_from or {}).get(login) %}
                      <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">Default From: <span class="mono">{{ (cfg.default_from or {}).get(login) }}</span></div>
                    {% endif %}
                  </div>
                  <div class="col-span-12 sm:col-span-8">
                    {% if (addrs or [])|length == 0 %}
                      <div class="text-sm text-slate-500 dark:text-slate-400">(none)</div>
                    {% else %}
                      <div class="flex flex-wrap gap-2">
                        {% for a in addrs %}
                          <form method="post" action="/from/disallow" class="inline-flex">
                            <input type="hidden" name="login" value="{{ login }}" />
                            <input type="hidden" name="from_addr" value="{{ a }}" />
                            <button type="submit" class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1 text-xs font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" title="Click to remove">
                              <i data-lucide="x" class="h-3.5 w-3.5"></i>
                              <span class="mono">{{ a }}</span>
                            </button>
                          </form>
                        {% endfor %}
                      </div>
                    {% endif %}
                  </div>
                </div>
              {% endfor %}

              {% if (cfg.allowed_from or {})|length == 0 %}
                <div class="px-3 py-4 text-sm text-slate-500 dark:text-slate-400">No sender rules configured yet.</div>
              {% endif %}
            </div>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 sm:grid-cols-2">
            <form id="fromAllowForm" method="post" action="/from/allow" class="space-y-2 rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-800 dark:bg-slate-950">
              <div class="text-sm font-semibold">Add allowed From</div>
              <div class="text-xs text-slate-500 dark:text-slate-400">This applies to authenticated clients (SMTP AUTH).</div>
              <input name="login" placeholder="login" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-900" />
              <input name="from_addr" placeholder="from@example.com" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-900" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-500">
                <i data-lucide="plus" class="h-4 w-4"></i>
                Add
              </button>
            </form>

            <form id="defaultFromForm" method="post" action="/from/default" class="space-y-2 rounded-2xl border border-slate-200 bg-slate-50 p-4 dark:border-slate-800 dark:bg-slate-950">
              <div class="text-sm font-semibold">Set default From</div>
              <div class="text-xs text-slate-500 dark:text-slate-400">Used when clients don’t specify a From address.</div>
              <input name="login" placeholder="login" class="mt-2 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-900" />
              <input name="from_addr" placeholder="default-from@example.com" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-900" />
              <button type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white hover:bg-blue-500">
                <i data-lucide="pin" class="h-4 w-4"></i>
                Save default
              </button>
            </form>

            <div class="sm:col-span-2 rounded-2xl border border-blue-200 bg-blue-50 p-4 text-sm text-blue-900 dark:border-blue-900/40 dark:bg-blue-950/40 dark:text-blue-200">
              <div class="flex items-start gap-2">
                <i data-lucide="info" class="mt-0.5 h-4 w-4"></i>
                <div>
                  The authenticated M365 user (<span class="mono">{{ env.MS365_SMTP_USER }}</span>) must have <span class="font-semibold">Send As</span> permissions for every mailbox/address you want to use as <span class="font-semibold">From</span>.
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- OAUTH -->
        <div id="oauth" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="key-round" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">OAuth</h2>
          </div>

          <div class="mt-3 rounded-2xl border border-slate-200 bg-slate-50 p-4 text-sm text-slate-700 dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200">
            {% if env.AUTO_TOKEN_REFRESH_MINUTES and env.AUTO_TOKEN_REFRESH_MINUTES != '0' %}
            <div class="mb-3 rounded-2xl border border-blue-200 bg-blue-50 p-3 text-xs text-blue-900 dark:border-blue-900/40 dark:bg-blue-950/40 dark:text-blue-200">
              <div class="flex items-start gap-2">
                <i data-lucide="info" class="mt-0.5 h-4 w-4"></i>
                <div>
                  Auto-refresh is enabled: the token is refreshed automatically every <span class="font-semibold">{{ env.AUTO_TOKEN_REFRESH_MINUTES }}</span> minutes.
                </div>
              </div>
            </div>
            {% endif %}
            <div class="flex items-start gap-3">
              <div class="mt-0.5" id="oauthStatusIcon">
                <i data-lucide="badge-check" class="h-5 w-5"></i>
              </div>
              <div class="flex-1">
                <div class="font-semibold">Current token status</div>
                <div class="mt-1 text-xs text-slate-600 dark:text-slate-300">
                  <span id="oauthStatusText" class="font-semibold">(unknown)</span>
                  <span class="opacity-50">•</span>
                  Expiry: <span class="mono" id="oauthTokenExp" data-ts="{{ token_exp_ts or '' }}">(unknown)</span>
                </div>
                <div class="mt-2 text-xs text-slate-600 dark:text-slate-300">
                  You normally don’t need device flow unless you want to re-authenticate or rotate the token.
                </div>
                <div class="mt-1 text-xs text-slate-600 dark:text-slate-300">
                  Last refresh: <span id="oauthLastRefresh" class="mono">(unknown)</span>
                </div>
                {% if not env.AUTO_TOKEN_REFRESH_MINUTES or env.AUTO_TOKEN_REFRESH_MINUTES == '0' %}
                <div class="mt-1 text-xs text-slate-600 dark:text-slate-300">
                  Auto-refresh: <span class="font-semibold">off</span> (default is every 30 min)
                </div>
                {% endif %}
              </div>
              <div class="flex flex-col gap-2 sm:flex-row">
                <form id="oauthRefreshForm" method="post" action="/token/refresh">
                  <button id="oauthRefreshBtn" type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl bg-blue-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-50" title="Manually refresh the OAuth token (uses existing refresh token)">
                    <i data-lucide="wand-2" class="h-4 w-4"></i>
                    Refresh token
                  </button>
                </form>
                <form id="oauthReauthForm" method="post" action="/token/start">
                  <button id="oauthReauthBtn" type="submit" class="inline-flex w-full items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-900 dark:hover:bg-slate-800" title="Start a new OAuth device flow and overwrite the token in the shared volume">
                    <i data-lucide="refresh-cw" class="h-4 w-4"></i>
                    Restart device flow
                  </button>
                </form>

                <div id="deviceFlowCallout" class="hidden sm:col-span-2 rounded-2xl border border-slate-200 bg-white p-3 text-xs text-slate-700 shadow-sm dark:border-slate-800 dark:bg-slate-950 dark:text-slate-200">
                  <div class="flex items-start justify-between gap-3">
                    <div>
                      <div class="font-semibold">Device flow</div>
                      <div class="mt-1">Open <a id="deviceFlowUrl" class="underline" href="#" target="_blank" rel="noreferrer">microsoft.com/devicelogin</a> and enter code:</div>
                      <div class="mt-1 inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 font-semibold dark:border-slate-800 dark:bg-slate-900/40">
                        <span id="deviceFlowCode" class="mono text-sm">…</span>
                        <button type="button" class="inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-white px-2 py-1 text-[11px] font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" onclick="copyText('deviceFlowCode')">
                          <i data-lucide="copy" class="h-3.5 w-3.5"></i>
                          Copy
                        </button>
                      </div>
                    </div>
                    <button type="button" class="rounded-lg px-2 py-1 opacity-70 hover:opacity-100" onclick="document.getElementById('deviceFlowCallout')?.classList.add('hidden')">
                      <i data-lucide="x" class="h-4 w-4"></i>
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="mt-4 text-xs text-slate-600 dark:text-slate-300">
            <a href="#logs" data-nav class="inline-flex items-center gap-2 font-semibold underline">
              <i data-lucide="scroll-text" class="h-4 w-4"></i>
              View OAuth logs
            </a>
          </div>
        </div>

        <!-- TEST MAIL -->
        <div id="testmail" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="send" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">Test mail</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Sends via local <span class="mono">sendmail</span> in the Postfix container (so it goes through the configured relay).</p>

          <form id="testmailForm" method="post" action="/testmail" class="mt-4 grid grid-cols-1 gap-3 sm:grid-cols-2">
            <div class="sm:col-span-1">
              <label class="text-sm font-medium">From</label>
              <div class="mt-1 flex gap-2">
                <select id="fromSelect" class="w-44 shrink-0 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" onchange="syncFromSelect()">
                  <option value="">Custom…</option>
                  {% for a in from_identities %}
                  <option value="{{ a }}">{{ a }}</option>
                  {% endfor %}
                </select>
                <input id="fromInput" name="from_addr" placeholder="from@example.com" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
              </div>
              <div class="mt-1 text-xs text-slate-500 dark:text-slate-400">Tip: M365 must allow “Send As” for this From address.</div>
            </div>
            <div class="sm:col-span-1">
              <label class="text-sm font-medium">To</label>
              <div class="mt-1 flex gap-2">
                <input id="toInput" name="to_addr" placeholder="to@example.com" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
                <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" onclick="fillToMyself()" title="Send to M365 user">
                  <i data-lucide="user" class="h-4 w-4"></i>
                  Myself
                </button>
              </div>
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm font-medium">Subject</label>
              <input name="subject" value="Test message" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" />
            </div>
            <div class="sm:col-span-2">
              <label class="text-sm font-medium">Body</label>
              <textarea name="body" rows="5" class="mt-1 w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950">Does it work?</textarea>
            </div>
            <div class="sm:col-span-2 flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between">
              <div class="text-xs text-slate-500 dark:text-slate-400">If this errors: check “Recent warnings / errors” and “Queue (mailq)”.</div>
              <button id="testmailBtn" type="submit" class="inline-flex items-center gap-2 rounded-xl bg-blue-600 px-4 py-2 text-sm font-semibold text-white shadow-sm hover:bg-blue-500 disabled:cursor-not-allowed disabled:opacity-50">
                <i data-lucide="send" class="h-4 w-4"></i>
                Send test mail
              </button>
            </div>

            <div class="sm:col-span-2">
              <details class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-950">
                <summary class="cursor-pointer text-sm font-semibold">Last send output</summary>
                <pre id="testmailOut" class="mono mt-3 max-h-56 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs dark:border-slate-800 dark:bg-slate-900/40">(none)</pre>
              </details>
            </div>
          </form>
        </div>

        <!-- LOGS -->
        <div id="logs" class="scroll-mt-24 rounded-2xl border border-slate-200 bg-white p-5 shadow-sm dark:border-slate-800 dark:bg-slate-900">
          <div class="flex items-center gap-2">
            <i data-lucide="scroll-text" class="h-5 w-5 text-slate-500"></i>
            <h2 class="text-lg font-semibold">Logs</h2>
          </div>
          <p class="mt-1 text-sm text-slate-600 dark:text-slate-300">Queue + recent Postfix activity (client-side filtering).</p>

          <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
            <details class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-950">
              <summary class="cursor-pointer text-sm font-semibold">OAuth device flow log (tail)</summary>
              <pre class="mono mt-3 max-h-72 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs dark:border-slate-800 dark:bg-slate-900/40">{{ device_flow_log }}</pre>
            </details>
            <details class="rounded-2xl border border-slate-200 bg-white p-4 dark:border-slate-800 dark:bg-slate-950">
              <summary class="cursor-pointer text-sm font-semibold">OAuth token refresh log (tail)</summary>
              <pre id="tokenRefreshLogPre" class="mono mt-3 max-h-72 overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs dark:border-slate-800 dark:bg-slate-900/40">{{ token_refresh_log or '' }}</pre>
            </details>
          </div>

          <div class="mt-4 grid grid-cols-1 gap-4 lg:grid-cols-2">
            <div>
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Queue (mailq)</div>
                <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" onclick="copyText('mailqPre2')">
                  <i data-lucide="copy" class="h-3.5 w-3.5"></i>
                  Copy
                </button>
              </div>
              <pre id="mailqPre2" class="mono mt-2 max-h-[28rem] overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs dark:border-slate-800 dark:bg-slate-950">{{ mailq or "" }}</pre>
            </div>

            <div>
              <div class="flex items-center justify-between">
                <div class="text-sm font-semibold">Mail log (tail)</div>
                <button type="button" class="inline-flex items-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" onclick="copyText('mailLogPre')">
                  <i data-lucide="copy" class="h-3.5 w-3.5"></i>
                  Copy
                </button>
              </div>

              <div class="mt-2 flex flex-col gap-2 sm:flex-row sm:items-center">
                <label class="inline-flex items-center gap-2 text-xs text-slate-600 dark:text-slate-300">
                  <input id="logOnlyProblems" type="checkbox" class="h-4 w-4" onchange="applyLogFilter()" />
                  Show only warnings/errors
                </label>
                <input id="logSearch" placeholder="Filter… (e.g. sasl-xoauth2, deferred, sent)" class="w-full rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm shadow-sm focus:border-blue-500 focus:outline-none dark:border-slate-800 dark:bg-slate-950" oninput="applyLogFilter()" />
                <button type="button" class="inline-flex items-center justify-center gap-2 rounded-xl border border-slate-200 bg-white px-3 py-2 text-sm font-semibold shadow-sm hover:bg-slate-50 dark:border-slate-800 dark:bg-slate-950 dark:hover:bg-slate-800" onclick="clearLogFilter()">
                  <i data-lucide="eraser" class="h-4 w-4"></i>
                  Clear
                </button>
              </div>

              <pre id="mailLogPre" class="mono mt-2 max-h-[28rem] overflow-auto rounded-xl border border-slate-200 bg-slate-50 p-3 text-xs dark:border-slate-800 dark:bg-slate-950" data-fulljson='{{ mail_log | tojson }}'>{{ mail_log }}</pre>
            </div>
          </div>
        </div>

      </section>

    </main>
  </div>
</body>
</html>
